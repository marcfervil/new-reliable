<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>New Reliable</title>
        <style>
            img {
                -webkit-user-drag: none;
                -khtml-user-drag: none;
                -moz-user-drag: none;
                -o-user-drag: none;
            }
           
        </style>
    </head>
    <body>
          <!-- <path d="M 50 50 c 25 50, 75 -50, 100 0" fill="transparent" stroke="black"/>-->
        
        <svg style="position: absolute; top:0px; left:0px; width:100%; height:100%; z-index:-1" id="path"> </svg>
      
        <!--img id="image" style="position:absolute;" src="https://media.giphy.com/media/JIX9t2j0ZTN9S/giphy.gif" width="300" /-->
        <button onClick="clearPath()">Clear</button>
      
    </body>
</html>


<script src="{{path}}/jquery.js" type="text/javascript"></script>
<script src="{{path}}/reliable.js" type="text/javascript"></script>
<script src="{{path}}/Vector2.js" type="text/javascript"></script>
<script  type="application/javascript" src="file:///Users/marcfervil/Documents/Programming/NewReliable/new-reliable/WebContent/Vector2.js"></script>
<script src="file:///Users/marcfervil/Documents/Programming/NewReliable/new-reliable/WebContent/reliable.js" type="text/javascript"></script>
<script src="file:///Users/marcfervil/Documents/Programming/NewReliable/new-reliable/WebContent/jquery.js" type="text/javascript"></script>

<script type="text/javascript">
    
    //https://mavo.io/demos/svgpath/
    //https://yqnn.github.io/svg-path-editor/

    let vscode = undefined;
   
    let isVsCode = !(typeof acquireVsCodeApi === 'undefined');
    if(isVsCode) vscode = acquireVsCodeApi();

    let currentSvg = undefined;
   
    let svgs = [];

    $("#image").hide();


    onDrag($("#path")[0], drag, dragStart, dragComplete);


    function dragStart(pos){
        currentSvg = new SVG("path", new Vector2(pos.x, pos.y));
       // makeDraggable(currentSvg.svg);
    }

    document.onpaste = function(pasteEvent) {
  // consider the first item (can be easily extended for multiple items)
        var item = pasteEvent.clipboardData.items[0];
        
       // alert(item.type);

        if (item.type.indexOf("image") === 0) {
            var blob = item.getAsFile();
        
            var reader = new FileReader();
            reader.onload = function(event) {
                svgs.push(new ImageSVG("path", new Vector2(), event.target.result));
            };
        
            reader.readAsDataURL(blob);
        }
    }

    function drag(pos){
        currentSvg.addPoint(new Vector2(pos.x, pos.y));
    }


    function dragComplete(){
      

        currentSvg.smoothify();
        
        svgs.push(currentSvg);
        if(isVsCode){
            vscode.postMessage({
                command: "Draw",
                id: currentSvg.id,
                pos: currentSvg.pos.toJSON(),
                path: currentSvg.pathData
            });
        }
    
        
    }

    function undo(){
        svgs.pop().delete();
        console.log(event);
        event.stopPropagation();
    }


    function clearPath(){
        $("#path").empty();
        svgs = [];
    }

    if(isVsCode){
        window.addEventListener('message', event => {
            const message = event.data; 

            if(message.command == "Drag"){
                let element = document.getElementById(message.id);
                element.style.left = message.pos.x;
                element.style.top = message.pos.y;
            }else if(message.command == "Draw"){
                console.log("Draw From VSCode")
                let svg = new SVG("path", new Vector2(message.pos.x, message.pos.y), message.id);
                svg.replaceSvg(svg.pathData);
            }
        });
    }


    document.addEventListener('keydown', function(event) {
        if ((event.ctrlKey && event.key === 'z') || (event.metaKey && event.key === 'z')) {
            undo();
        }
    });


    var div = document.createElement("div"); 
    document.body.appendChild(div);

</script>